[tox]
env_list = unit, e2e
isolated_build = false

[testenv]
passenv = BASE_URL PIHEALTH_USER PIHEALTH_PASSWORD PORT
deps =
    -r requirements.txt
    -r tests/requirements.txt

[testenv:unit]
commands =
    pytest tests/ -v -m "not e2e"

[testenv:e2e]
allowlist_externals = playwright
commands =
    playwright install chromium
    pytest -m e2e tests/e2e -v

[testenv:all]
allowlist_externals = playwright bash
commands =
    pytest tests/ -v -m "not e2e"
    playwright install chromium
    bash -lc 'PORT=${PORT:-8002} python app.py & APP_PID=$!; for i in {1..30}; do python - <<PY
import os, urllib.request
port = os.environ.get("PORT", "8002")
try:
    urllib.request.urlopen(f"http://localhost:{port}/api/theme", timeout=1)
    raise SystemExit(0)
except Exception:
    raise SystemExit(1)
PY
if [ $? -eq 0 ]; then break; fi; sleep 1; done; BASE_URL=${BASE_URL:-http://localhost:${PORT:-8002}} pytest -m e2e tests/e2e -v; kill $APP_PID'
